name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      kv_namespace_id:
        description: 'KV Namespace ID (å¯é€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨åˆ›å»º)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Frontend
        run: npm run build

      - name: Setup Wrangler
        run: npm install -g wrangler

      - name: Verify Cloudflare Credentials
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ” éªŒè¯ Cloudflare å‡­è¯..."

          # æ£€æŸ¥ secrets æ˜¯å¦è®¾ç½®
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN æœªè®¾ç½®"
            echo "è¯·åœ¨ Repository Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          echo "âœ… CLOUDFLARE_API_TOKEN å·²è®¾ç½®"

          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID æœªè®¾ç½®"
            echo "è¯·åœ¨ Repository Settings â†’ Secrets and variables â†’ Actions ä¸­æ·»åŠ "
            exit 1
          fi
          echo "âœ… CLOUDFLARE_ACCOUNT_ID å·²è®¾ç½®"

          # éªŒè¯ API Token æ˜¯å¦æœ‰æ•ˆ
          echo "ðŸ” éªŒè¯ API Token æœ‰æ•ˆæ€§..."
          VERIFY_RESULT=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/tokens/verify" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")

          if echo "$VERIFY_RESULT" | grep -q '"success":true'; then
            echo "âœ… API Token æœ‰æ•ˆ"
            # æ˜¾ç¤º token çŠ¶æ€
            STATUS=$(echo "$VERIFY_RESULT" | jq -r '.result.status // "unknown"')
            echo "   Token çŠ¶æ€: $STATUS"
          else
            echo "âŒ API Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
            echo "é”™è¯¯è¯¦æƒ…: $(echo "$VERIFY_RESULT" | jq -r '.errors[0].message // "æœªçŸ¥é”™è¯¯"')"
            echo ""
            echo "è¯·æ£€æŸ¥:"
            echo "  1. Token æ˜¯å¦æ­£ç¡®å¤åˆ¶ï¼ˆæ— å¤šä½™ç©ºæ ¼ï¼‰"
            echo "  2. Token æ˜¯å¦æœ‰ Workers ç›¸å…³æƒé™"
            echo "  3. Token æ˜¯å¦å·²è¿‡æœŸ"
            exit 1
          fi

          # éªŒè¯ Account ID
          echo "ðŸ” éªŒè¯ Account ID..."
          ACCOUNT_RESULT=$(curl -s -X GET "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json")

          if echo "$ACCOUNT_RESULT" | grep -q '"success":true'; then
            ACCOUNT_NAME=$(echo "$ACCOUNT_RESULT" | jq -r '.result.name // "æœªçŸ¥"')
            echo "âœ… Account ID æœ‰æ•ˆ"
            echo "   è´¦æˆ·åç§°: $ACCOUNT_NAME"
          else
            echo "âŒ Account ID æ— æ•ˆæˆ–æ— æƒé™è®¿é—®"
            echo "é”™è¯¯è¯¦æƒ…: $(echo "$ACCOUNT_RESULT" | jq -r '.errors[0].message // "æœªçŸ¥é”™è¯¯"')"
            exit 1
          fi

          echo ""
          echo "ðŸŽ‰ æ‰€æœ‰å‡­è¯éªŒè¯é€šè¿‡ï¼"

      - name: Get or Create KV Namespace
        id: kv
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ KV ID
          if [ -n "${{ github.event.inputs.kv_namespace_id }}" ]; then
            echo "kv_id=${{ github.event.inputs.kv_namespace_id }}" >> $GITHUB_OUTPUT
            echo "âœ… ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ KV ID: ${{ github.event.inputs.kv_namespace_id }}"
            exit 0
          fi

          # ä¼˜å…ˆä½¿ç”¨ secrets ä¸­çš„ KV ID
          if [ -n "${{ secrets.CLOUDFLARE_KV_ID }}" ]; then
            echo "kv_id=${{ secrets.CLOUDFLARE_KV_ID }}" >> $GITHUB_OUTPUT
            echo "âœ… ä½¿ç”¨ Secrets ä¸­çš„ KV ID"
            exit 0
          fi

          echo "ðŸ” æŸ¥æ‰¾çŽ°æœ‰ KV namespace..."

          # èŽ·å– KV åˆ—è¡¨ï¼ˆä½¿ç”¨ --json å‚æ•°ï¼‰
          KV_LIST=$(wrangler kv namespace list --json 2>&1 || echo "[]")

          # éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆ JSONï¼Œå¦‚æžœä¸æ˜¯åˆ™ä½¿ç”¨ç©ºæ•°ç»„
          if ! echo "$KV_LIST" | jq empty 2>/dev/null; then
            echo "âš ï¸ KV åˆ—è¡¨ä¸æ˜¯æœ‰æ•ˆ JSONï¼Œå°è¯•æå– JSON éƒ¨åˆ†..."
            KV_LIST=$(echo "$KV_LIST" | grep -E '^\[' || echo "[]")
            if ! echo "$KV_LIST" | jq empty 2>/dev/null; then
              echo "âš ï¸ æ— æ³•è§£æž KV åˆ—è¡¨ï¼Œä½¿ç”¨ç©ºæ•°ç»„"
              KV_LIST="[]"
            fi
          fi

          # æŸ¥æ‰¾ movecars ç›¸å…³çš„ namespace
          KV_ID=$(echo "$KV_LIST" | jq -r '.[] | select(.title | contains("movecars")) | .id' | head -1 || echo "")

          if [ -n "$KV_ID" ] && [ "$KV_ID" != "null" ]; then
            echo "âœ… æ‰¾åˆ°çŽ°æœ‰ KV namespace: $KV_ID"
            echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ“¦ åˆ›å»ºæ–°çš„ KV namespace..."
          CREATE_OUTPUT=$(wrangler kv namespace create "MOVECARS_KV" 2>&1)
          echo "$CREATE_OUTPUT"

          # å°è¯•å¤šç§æ–¹å¼è§£æž KV ID
          KV_ID=$(echo "$CREATE_OUTPUT" | grep -oE '[a-f0-9]{32}' | head -1 || echo "")

          # å¦‚æžœä¸Šé¢æ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ ¼å¼
          if [ -z "$KV_ID" ]; then
            KV_ID=$(echo "$CREATE_OUTPUT" | grep -oP 'id = "\K[^"]+' || echo "")
          fi

          if [ -z "$KV_ID" ]; then
            KV_ID=$(echo "$CREATE_OUTPUT" | grep -oP '"id":\s*"\K[^"]+' || echo "")
          fi

          if [ -z "$KV_ID" ]; then
            echo "âŒ åˆ›å»º KV namespace å¤±è´¥æˆ–æ— æ³•è§£æž ID"
            echo "è¯·æ‰‹åŠ¨åˆ›å»º KV namespace å¹¶å°† ID æ·»åŠ åˆ° Secrets:"
            echo "  1. è¿è¡Œ: wrangler kv namespace create MOVECARS_KV"
            echo "  2. å°†è¾“å‡ºçš„ ID æ·»åŠ åˆ° Repository Secrets: CLOUDFLARE_KV_ID"
            exit 1
          fi

          echo "âœ… åˆ›å»ºæˆåŠŸ: $KV_ID"
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ’¡ å»ºè®®å°†æ­¤ ID æ·»åŠ åˆ° Repository Secrets:"
          echo "   åç§°: CLOUDFLARE_KV_ID"
          echo "   å€¼: $KV_ID"

      - name: Generate wrangler.toml
        run: |
          cat > wrangler.toml << 'EOF'
          name = "movecars"
          main = "src/worker/index.ts"
          compatibility_date = "2024-12-18"
          compatibility_flags = ["nodejs_compat"]

          [[kv_namespaces]]
          binding = "MOVECARS_KV"
          id = "${{ steps.kv.outputs.kv_id }}"

          [assets]
          directory = "./dist"

          [vars]
          APP_NAME = "æ™ºèƒ½æŒªè½¦"
          EOF

          echo "ðŸ“„ ç”Ÿæˆçš„ wrangler.toml:"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Output Deploy Info
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸ!"
          echo ""
          echo "ðŸ“‹ é…ç½®ä¿¡æ¯:"
          echo "   KV Namespace ID: ${{ steps.kv.outputs.kv_id }}"
          echo ""
          echo "ðŸ’¡ å¦‚æžœè¿™æ˜¯é¦–æ¬¡éƒ¨ç½²ï¼Œè¯·å°† KV ID ä¿å­˜åˆ° Repository Secrets:"
          echo "   Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
          echo "   åç§°: CLOUDFLARE_KV_ID"
          echo "   å€¼: ${{ steps.kv.outputs.kv_id }}"
